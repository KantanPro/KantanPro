# 強化された自動マイグレーション機能の実装完了

## 概要

プラグインの新規インストール・再有効化・アップデート時に適格請求書ナンバー機能を含むすべての機能が自動でマイグレーションされるように、自動マイグレーション機能を強化しました。

## 実装内容

### 1. 適格請求書ナンバー機能のマイグレーション

#### 1.1 マイグレーションファイル
- **ファイル**: `includes/migrations/20250131_add_qualified_invoice_profit_calculation.php`
- **機能**: 適格請求書ナンバー機能のデータベース構造と設定を追加

#### 1.2 マイグレーション内容
- 協力会社テーブルに`qualified_invoice_number`カラムを追加
- コスト項目テーブルに`supplier_id`カラムを追加
- 既存のコスト項目データの`supplier_id`を更新
- 適格請求書ナンバー機能の設定オプションを追加

### 2. 自動マイグレーション機能の強化

#### 2.1 専用マイグレーション関数
- **関数**: `ktpwp_run_qualified_invoice_migration()`
- **機能**: 適格請求書ナンバー機能のマイグレーションを確実に実行

#### 2.2 プラグイン有効化時の強化
- **関数**: `ktpwp_plugin_activation()`
- **改善**: 適格請求書ナンバー機能のマイグレーションを確実に実行
- **通知**: 適格請求書ナンバー機能の有効化を通知

#### 2.3 プラグイン更新時の強化
- **関数**: `ktpwp_plugin_upgrade_migration()`
- **改善**: 適格請求書ナンバー機能のマイグレーションを確実に実行
- **通知**: 適格請求書ナンバー機能の更新を通知

#### 2.4 自動マイグレーションの強化
- **関数**: `ktpwp_run_auto_migrations()`
- **改善**: 適格請求書ナンバー機能のマイグレーションを確実に実行

### 3. マイグレーション状態管理の強化

#### 3.1 状態チェック機能
- **関数**: `ktpwp_check_migration_status()`
- **改善**: 適格請求書ナンバー機能の状態も含めてチェック

#### 3.2 管理画面表示
- **関数**: `ktpwp_admin_migration_status()`
- **改善**: 適格請求書ナンバー機能の状態も表示

### 4. バージョン管理

#### 4.1 プラグインバージョン更新
- **バージョン**: `1.0.11(preview)`
- **変更**: 適格請求書ナンバー機能を含むことを明記

## 自動マイグレーションの実行タイミング

### 1. プラグイン有効化時
```php
register_activation_hook( __FILE__, 'ktpwp_plugin_activation' );
```

### 2. プラグイン更新時
```php
add_action( 'upgrader_process_complete', 'ktpwp_plugin_upgrade_migration', 10, 2 );
```

### 3. プラグイン読み込み時
```php
add_action( 'plugins_loaded', 'ktpwp_run_auto_migrations', 8 );
```

### 4. データベース整合性チェック時
```php
add_action( 'plugins_loaded', 'ktpwp_check_database_integrity', 5 );
```

## マイグレーション実行順序

1. **基本テーブル作成**: `ktp_table_setup()`
2. **部署テーブル作成**: `ktpwp_create_department_table()`
3. **マイグレーションファイル実行**: `ktpwp_run_migration_files()`
4. **適格請求書ナンバー機能マイグレーション**: `ktpwp_run_qualified_invoice_migration()`
5. **テーブル構造修正**: `ktpwp_fix_table_structures()`
6. **既存データ修復**: `ktpwp_repair_existing_data()`
7. **DBバージョン更新**: `update_option( 'ktpwp_db_version', $plugin_version )`

## エラーハンドリング

### 1. マイグレーション失敗時の処理
- エラーログの記録
- 部分的な成功の記録
- 管理画面でのエラー通知

### 2. ロールバック機能
- 適格請求書ナンバー機能のロールバックメソッド
- 設定オプションの削除

## テスト機能

### 1. テストファイル
- **ファイル**: `test_auto_migration_enhanced.php`
- **機能**: 強化された自動マイグレーション機能のテスト

### 2. テストケース
1. **マイグレーション状態チェック**: 現在の状態を確認
2. **適格請求書ナンバー機能マイグレーション**: 専用マイグレーションのテスト
3. **プラグイン有効化時マイグレーション**: 有効化処理のテスト
4. **プラグイン更新時マイグレーション**: 更新処理のテスト
5. **データベース整合性チェック**: 整合性チェックのテスト

## 使用方法

### 1. 新規インストール
プラグインを有効化するだけで、すべての機能が自動でマイグレーションされます。

### 2. アップデート
プラグインを更新するだけで、新しい機能が自動でマイグレーションされます。

### 3. 再有効化
プラグインを無効化して再有効化するだけで、不足している機能が自動でマイグレーションされます。

### 4. テスト実行
```
https://your-site.com/wp-admin/admin.php?page=ktp&run_auto_migration_enhanced_test=1
```

## 技術仕様

### データベース
- **協力会社テーブル**: `qualified_invoice_number`カラム追加
- **コスト項目テーブル**: `supplier_id`カラム追加
- **設定オプション**: 適格請求書ナンバー機能関連の設定追加

### セキュリティ
- **権限チェック**: 管理者権限でのみマイグレーション実行
- **エラーハンドリング**: 適切なエラー処理とログ記録
- **ロールバック**: 失敗時の安全なロールバック機能

## 影響範囲

### 修正されたファイル
1. `ktpwp.php` - メインプラグインファイル
2. `includes/migrations/20250131_add_qualified_invoice_profit_calculation.php` - 新規マイグレーションファイル

### 新規作成ファイル
1. `test_auto_migration_enhanced.php` - テストファイル
2. `AUTO-MIGRATION-ENHANCEMENT-COMPLETE.md` - このドキュメント

## 注意事項

### 1. 後方互換性
- 既存のマイグレーション機能は維持されています
- 適格請求書ナンバー機能が設定されていない場合は従来通りの動作をします

### 2. パフォーマンス
- マイグレーションは必要な場合のみ実行されます
- 重複実行を防ぐ仕組みが組み込まれています

### 3. データ整合性
- 既存データの整合性を保つための処理が含まれています
- エラーが発生した場合でも安全に処理されます

## 今後の拡張予定

### 1. 追加機能のマイグレーション
- 新しい機能追加時の自動マイグレーション対応
- 依存関係のあるマイグレーションの自動順序制御

### 2. マイグレーション履歴管理
- マイグレーション実行履歴の詳細管理
- ロールバック履歴の管理

### 3. バッチ処理対応
- 大量データのマイグレーション対応
- バックグラウンド処理でのマイグレーション実行

## 実装完了日時

- **実装完了**: 2025年1月
- **テスト完了**: 2025年1月
- **ドキュメント作成**: 2025年1月

## 関連ドキュメント

- [適格請求書ナンバー機能の実装](QUALIFIED-INVOICE-PROFIT-CALCULATION-IMPLEMENTATION-COMPLETE.md)
- [自動マイグレーション機能の実装](AUTO-MIGRATION-IMPLEMENTATION-COMPLETE.md)
- [消費税対応の実装](INVOICE-TAX-IMPLEMENTATION-COMPLETE.md) 