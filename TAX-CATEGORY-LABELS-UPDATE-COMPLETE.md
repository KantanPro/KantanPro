# 税区分ラベル更新完了レポート

## 概要
顧客詳細の税区分オプションを「税込｜税別」から「内税｜外税」に変更する作業が完了しました。

## 修正内容

### 1. PHP側の修正

#### 1.1 顧客フォームの税区分オプション変更
**ファイル**: `includes/class-tab-client.php`
- 税区分の選択肢を「税込｜税抜」から「内税｜外税」に変更
- デフォルト値を「税込」から「内税」に変更

```php
'税区分' => array(
    'type' => 'select',
    'name' => 'tax_category',
    'options' => array( '内税', '外税' ),
    'default' => '内税',
),
```

#### 1.2 データベースデフォルト値の更新
**ファイル**: `includes/class-ktpwp-client-db.php`
- 顧客テーブルのtax_categoryカラムのデフォルト値を「税込」から「内税」に変更

```php
"tax_category VARCHAR(100) NOT NULL DEFAULT '" . __( '内税', 'ktpwp' ) . "'",
```

### 2. マイグレーションスクリプトの作成

#### 2.1 マイグレーションスクリプト
**ファイル**: `includes/migrations/20250131_update_tax_category_labels.php`
- 既存データベース内の「税込」を「内税」に更新
- 既存データベース内の「税抜」を「外税」に更新
- マイグレーション実行フラグの設定

#### 2.2 マイグレーション実行スクリプト
**ファイル**: `run_tax_category_migration.php`
- 管理者権限チェック付きのマイグレーション実行スクリプト
- 実行結果の表示

### 3. JavaScript側の修正

#### 3.1 一括請求書発行機能の税区分判定更新
**ファイル**: `js/ktp-client-invoice.js`
- 税区分判定を「税抜」から「外税」に変更
- 表示テキストを「税込」から「内税」に変更
- 表示テキストを「税抜」から「外税」に変更

**修正箇所**:
1. 月別グループの合計計算ロジック
2. 全体合計金額の表示
3. 個別受注書の小計表示
4. 月別グループの合計表示

**変更内容**:
- `res.data.tax_category === '税抜'` → `res.data.tax_category === '外税'`
- 「税込合計」→「内税合計」
- 「税抜合計」→「外税合計」
- 「税込小計」→「内税小計」
- 「税抜小計」→「外税小計」

## 影響範囲

### 新規顧客登録
- 新規顧客の税区分デフォルト値が「内税」になります

### 既存顧客データ
- 既存の「税込」データは「内税」に更新されます
- 既存の「税抜」データは「外税」に更新されます

### 一括請求書発行機能
- 税区分に応じた表示が「内税｜外税」に変更されます
- 計算ロジックは変更されません（表示のみ変更）

## 実行手順

### 1. マイグレーションの実行
本番環境で以下のコマンドを実行してください：

```bash
php run_tax_category_migration.php
```

### 2. 動作確認
1. 顧客詳細画面で税区分の選択肢が「内税｜外税」になっていることを確認
2. 新規顧客登録時にデフォルト値が「内税」になっていることを確認
3. 一括請求書発行機能で税区分に応じた表示が正しく表示されることを確認

## 注意事項

1. **データベース接続**: マイグレーション実行時はWordPress環境が正常に動作していることを確認してください
2. **バックアップ**: 実行前にデータベースのバックアップを取得することを推奨します
3. **権限**: マイグレーション実行には管理者権限が必要です

## 完了項目

- [x] PHP側の税区分オプション変更
- [x] データベースデフォルト値の更新
- [x] マイグレーションスクリプトの作成
- [x] JavaScript側の税区分判定更新
- [x] 表示テキストの更新
- [x] 実行スクリプトの作成

## 技術仕様

### データベース変更
- テーブル: `wp_ktp_client`
- カラム: `tax_category`
- デフォルト値: `'内税'`

### フロントエンド変更
- フォーム選択肢: `['内税', '外税']`
- デフォルト選択: `'内税'`

### バックエンド変更
- 税区分判定: `'外税'` で外税処理
- デフォルト処理: 内税処理

---

**更新日**: 2025年1月31日  
**担当者**: AI Assistant  
**バージョン**: 1.0.0 