<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>税率変更リアルタイム計算テスト</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        input[type="number"] {
            width: 80px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .total-display {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: bold;
        }
        .tax-display {
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 3px;
            margin-top: 5px;
            color: #666;
        }
        .profit-display {
            background-color: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: bold;
            color: #155724;
        }
        .profit-display.negative {
            background-color: #f8d7da;
            color: #721c24;
        }
        .debug-info {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>税率変更リアルタイム計算テスト</h1>
        
        <div class="test-section">
            <h3>請求項目テスト</h3>
            <table class="invoice-items-table">
                <thead>
                    <tr>
                        <th>商品名</th>
                        <th>単価</th>
                        <th>数量</th>
                        <th>単位</th>
                        <th>金額</th>
                        <th>税率</th>
                        <th>備考</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="invoice-item-row">
                        <td><input type="text" class="product-name" value="テスト商品1"></td>
                        <td><input type="number" class="price" value="1000" step="1"></td>
                        <td><input type="number" class="quantity" value="2" step="1"></td>
                        <td><input type="text" class="unit" value="式"></td>
                        <td><input type="number" class="amount" value="2000" readonly></td>
                        <td><input type="number" class="tax-rate" value="10" step="1" min="0" max="100" style="width:50px;">%</td>
                        <td><input type="text" class="remarks" value=""></td>
                    </tr>
                    <tr class="invoice-item-row">
                        <td><input type="text" class="product-name" value="テスト商品2"></td>
                        <td><input type="number" class="price" value="500" step="1"></td>
                        <td><input type="number" class="quantity" value="3" step="1"></td>
                        <td><input type="text" class="unit" value="式"></td>
                        <td><input type="number" class="amount" value="1500" readonly></td>
                        <td><input type="number" class="tax-rate" value="8" step="1" min="0" max="100" style="width:50px;">%</td>
                        <td><input type="text" class="remarks" value=""></td>
                    </tr>
                </tbody>
            </table>
            
            <div class="total-display invoice-items-total">合計金額: 3,500円</div>
            <div class="tax-display invoice-items-tax">消費税: 350円</div>
            <div class="total-display invoice-items-total-with-tax">税込合計: 3,850円</div>
        </div>
        
        <div class="test-section">
            <h3>コスト項目テスト</h3>
            <table class="cost-items-table">
                <thead>
                    <tr>
                        <th>商品名</th>
                        <th>単価</th>
                        <th>数量</th>
                        <th>単位</th>
                        <th>金額</th>
                        <th>税率</th>
                        <th>備考</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="cost-item-row">
                        <td><input type="text" class="product-name" value="コスト商品1"></td>
                        <td><input type="number" class="price" value="800" step="1"></td>
                        <td><input type="number" class="quantity" value="1" step="1"></td>
                        <td><input type="text" class="unit" value="式"></td>
                        <td><input type="number" class="amount" value="800" readonly></td>
                        <td><input type="number" class="tax-rate" value="10" step="1" min="0" max="100" style="width:50px;">%</td>
                        <td><input type="text" class="remarks" value=""></td>
                    </tr>
                </tbody>
            </table>
            
            <div class="total-display cost-items-total">金額合計: 800円</div>
        </div>
        
        <div class="profit-display">利益: 3,050円</div>
        
        <div class="debug-info" id="debug-info">
            デバッグ情報がここに表示されます...
        </div>
        
        <div class="test-section">
            <h3>テスト操作</h3>
            <button onclick="testTaxRateChange()">税率変更テスト</button>
            <button onclick="testPriceChange()">単価変更テスト</button>
            <button onclick="testQuantityChange()">数量変更テスト</button>
            <button onclick="clearDebug()">デバッグクリア</button>
        </div>
    </div>

    <script>
        // デバッグモードを有効化
        window.ktpDebugMode = true;
        
        // デバッグ情報を表示する関数
        function logDebug(message) {
            const debugInfo = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            console.log(message);
        }
        
        // 小数点以下の不要な0を削除する関数
        function formatDecimalDisplay(value) {
            if (value === '' || value === null || value === undefined) {
                return '';
            }
            const num = parseFloat(value);
            if (isNaN(num)) {
                return value;
            }
            return num.toFixed(6).replace(/\.?0+$/, '');
        }

        // 価格×数量の自動計算
        function calculateAmount(row) {
            const priceValue = row.find('.price').val();
            const quantityValue = row.find('.quantity').val();
            
            const price = (priceValue === '' || priceValue === null || isNaN(priceValue)) ? 0 : parseFloat(priceValue);
            const quantity = (quantityValue === '' || quantityValue === null || isNaN(quantityValue)) ? 0 : parseFloat(quantityValue);
            const amount = Math.ceil(price * quantity);
            
            const finalAmount = isNaN(amount) ? 0 : amount;
            
            logDebug(`calculateAmount: 単価${price} × 数量${quantity} = ${finalAmount}`);
            
            row.find('.amount').val(finalAmount);
            
            // 合計と利益を更新
            updateTotalAndProfit();
        }

        // 請求項目合計と利益表示を更新
        function updateTotalAndProfit() {
            let invoiceTotal = 0;
            let costTotal = 0;
            let totalTaxAmount = 0;
            let costTotalTaxAmount = 0;

            // 税率別の集計用オブジェクト
            let taxRateGroups = {};
            let costTaxRateGroups = {};

            // 顧客の税区分を取得（デフォルトは内税）
            let taxCategory = '内税';

            // 請求項目の合計と消費税を計算（税率別に集計）
            $('.invoice-items-table tbody tr').each(function () {
                const $row = $(this);
                const amount = parseFloat($row.find('.amount').val()) || 0;
                const taxRateInput = $row.find('.tax-rate').val();
                
                // 税率の処理（NULL、空文字、NaNの場合は税率なしとして扱う）
                let taxRate = null;
                if (taxRateInput !== null && taxRateInput !== '' && !isNaN(parseFloat(taxRateInput))) {
                    taxRate = parseFloat(taxRateInput);
                }
                
                invoiceTotal += amount;
                
                // 税率別に集計（税率なしの場合は'no_tax_rate'として扱う）
                const taxRateKey = taxRate !== null ? taxRate.toString() : 'no_tax_rate';
                if (!taxRateGroups[taxRateKey]) {
                    taxRateGroups[taxRateKey] = 0;
                }
                taxRateGroups[taxRateKey] += amount;
            });

            // 税区分に応じて消費税を計算
            if (taxCategory === '外税') {
                // 外税表示の場合：各項目の税抜金額から税額を計算（切り上げ）
                $('.invoice-items-table tbody tr').each(function () {
                    const $row = $(this);
                    const amount = parseFloat($row.find('.amount').val()) || 0;
                    const taxRateInput = $row.find('.tax-rate').val();
                    
                    let taxRate = null;
                    if (taxRateInput !== null && taxRateInput !== '' && !isNaN(parseFloat(taxRateInput))) {
                        taxRate = parseFloat(taxRateInput);
                    }
                    
                    if (taxRate !== null) {
                        const taxAmount = Math.ceil(amount * (taxRate / 100));
                        totalTaxAmount += taxAmount;
                    }
                });
            } else {
                // 内税表示の場合：税率別に税額を計算
                Object.keys(taxRateGroups).forEach(taxRateKey => {
                    const groupAmount = taxRateGroups[taxRateKey];
                    
                    if (taxRateKey !== 'no_tax_rate') {
                        const rate = parseFloat(taxRateKey);
                        const taxAmount = Math.ceil(groupAmount * (rate / 100) / (1 + rate / 100));
                        totalTaxAmount += taxAmount;
                    }
                });
            }

            // コスト項目の合計と消費税を計算
            $('.cost-items-table tbody tr').each(function () {
                const $row = $(this);
                const amount = parseFloat($row.find('.amount').val()) || 0;
                const taxRateInput = $row.find('.tax-rate').val();
                
                let taxRate = null;
                if (taxRateInput !== null && taxRateInput !== '' && !isNaN(parseFloat(taxRateInput))) {
                    taxRate = parseFloat(taxRateInput);
                }
                
                costTotal += amount;
                
                const taxRateKey = taxRate !== null ? taxRate.toString() : 'no_tax_rate';
                if (!costTaxRateGroups[taxRateKey]) {
                    costTaxRateGroups[taxRateKey] = 0;
                }
                costTaxRateGroups[taxRateKey] += amount;
                
                if (taxRate !== null) {
                    const taxAmount = Math.ceil(amount * (taxRate / 100) / (1 + taxRate / 100));
                    costTotalTaxAmount += taxAmount;
                }
            });

            // 請求項目合計を切り上げ
            const invoiceTotalCeiled = Math.ceil(invoiceTotal);
            const costTotalCeiled = Math.ceil(costTotal);
            const totalTaxAmountCeiled = Math.ceil(totalTaxAmount);
            const costTotalTaxAmountCeiled = Math.ceil(costTotalTaxAmount);

            // 税込合計を計算
            const totalWithTax = invoiceTotalCeiled + totalTaxAmountCeiled;
            const costTotalWithTax = costTotalCeiled + costTotalTaxAmountCeiled;

            // 利益計算
            const profit = totalWithTax - costTotalWithTax;

            // 請求項目の合計表示を更新
            const invoiceTotalDisplay = $('.invoice-items-total');
            if (invoiceTotalDisplay.length > 0) {
                if (taxCategory === '外税') {
                    invoiceTotalDisplay.html('合計金額 : ' + invoiceTotalCeiled.toLocaleString() + '円');
                    
                    const taxDisplay = $('.invoice-items-tax');
                    if (taxDisplay.length > 0) {
                        let taxDetailHtml = '消費税 : ' + totalTaxAmountCeiled.toLocaleString() + '円';
                        
                        const taxRateDetails = [];
                        Object.keys(taxRateGroups).sort((a, b) => {
                            if (a === 'no_tax_rate') return 1;
                            if (b === 'no_tax_rate') return -1;
                            return parseFloat(b) - parseFloat(a);
                        }).forEach(taxRateKey => {
                            if (taxRateKey !== 'no_tax_rate') {
                                const rate = parseFloat(taxRateKey);
                                const groupAmount = taxRateGroups[taxRateKey];
                                const taxAmount = Math.ceil(groupAmount * (rate / 100));
                                if (groupAmount > 0) {
                                    taxRateDetails.push(`${rate}%: ${taxAmount.toLocaleString()}円`);
                                }
                            }
                        });
                        
                        if (taxRateDetails.length > 1) {
                            taxDetailHtml += ' (' + taxRateDetails.join(', ') + ')';
                        }
                        
                        taxDisplay.html(taxDetailHtml);
                    }

                    const totalWithTaxDisplay = $('.invoice-items-total-with-tax');
                    if (totalWithTaxDisplay.length > 0) {
                        totalWithTaxDisplay.html('税込合計 : ' + totalWithTax.toLocaleString() + '円');
                    }
                } else {
                    let totalDisplayHtml = '金額合計：' + invoiceTotalCeiled.toLocaleString() + '円';
                    
                    const taxRateDetails = [];
                    Object.keys(taxRateGroups).sort((a, b) => {
                        if (a === 'no_tax_rate') return 1;
                        if (b === 'no_tax_rate') return -1;
                        return parseFloat(b) - parseFloat(a);
                    }).forEach(taxRateKey => {
                        if (taxRateKey !== 'no_tax_rate') {
                            const rate = parseFloat(taxRateKey);
                            const groupAmount = taxRateGroups[taxRateKey];
                            const taxAmount = Math.ceil(groupAmount * (rate / 100) / (1 + rate / 100));
                            if (groupAmount > 0) {
                                taxRateDetails.push(`${rate}%: ${taxAmount.toLocaleString()}円`);
                            }
                        }
                    });
                    
                    if (taxRateDetails.length > 0) {
                        totalDisplayHtml += '　（内税：' + taxRateDetails.join(', ') + '）';
                    }
                    
                    invoiceTotalDisplay.html(totalDisplayHtml);
                    
                    const taxDisplay = $('.invoice-items-tax');
                    if (taxDisplay.length > 0) {
                        taxDisplay.html('');
                    }

                    const totalWithTaxDisplay = $('.invoice-items-total-with-tax');
                    if (totalWithTaxDisplay.length > 0) {
                        totalWithTaxDisplay.html('');
                    }
                }
            }

            // コスト項目の合計表示を更新
            const costTotalDisplay = $('.cost-items-total');
            if (costTotalDisplay.length > 0) {
                costTotalDisplay.html('金額合計：' + costTotalCeiled.toLocaleString() + '円　（内税：' + costTotalTaxAmountCeiled.toLocaleString() + '円）');
            }

            // 利益表示を更新
            const profitDisplay = $('.profit-display');
            if (profitDisplay.length > 0) {
                const profitColor = profit >= 0 ? '#28a745' : '#dc3545';
                profitDisplay.html('利益 : ' + profit.toLocaleString() + '円');
                profitDisplay.css('color', profitColor);

                profitDisplay.removeClass('positive negative');
                profitDisplay.addClass(profit >= 0 ? 'positive' : 'negative');
            }

            logDebug(`updateTotalAndProfit: 請求項目合計=${invoiceTotalCeiled}, 消費税=${totalTaxAmountCeiled}, コスト合計=${costTotalCeiled}, 利益=${profit}`);
        }

        // イベントハンドラの設定
        $(document).ready(function() {
            // 単価・数量変更時の金額自動計算
            $(document).on('blur', '.invoice-items-table .price, .invoice-items-table .quantity', function () {
                const $field = $(this);
                const row = $field.closest('tr');
                logDebug(`単価・数量変更: ${$field.val()}`);
                calculateAmount(row);
            });

            // 税率変更時のリアルタイム再計算
            $(document).on('change', '.invoice-items-table .tax-rate', function () {
                const $field = $(this);
                const value = $field.val();
                const row = $field.closest('tr');
                logDebug(`税率変更イベント: ${value}%`);
                updateTotalAndProfit();
            });

            // 税率入力時のリアルタイム再計算
            $(document).on('input', '.invoice-items-table .tax-rate', function () {
                const $field = $(this);
                const value = $field.val();
                const row = $field.closest('tr');
                logDebug(`税率入力イベント: ${value}%`);
                updateTotalAndProfit();
            });

            // コスト項目の税率変更
            $(document).on('change', '.cost-items-table .tax-rate', function () {
                const $field = $(this);
                const value = $field.val();
                logDebug(`コスト税率変更: ${value}%`);
                updateTotalAndProfit();
            });

            $(document).on('input', '.cost-items-table .tax-rate', function () {
                const $field = $(this);
                const value = $field.val();
                logDebug(`コスト税率入力: ${value}%`);
                updateTotalAndProfit();
            });

            // 初期計算
            updateTotalAndProfit();
        });

        // テスト関数
        function testTaxRateChange() {
            logDebug('=== 税率変更テスト開始 ===');
            $('.invoice-items-table .tax-rate').first().val('15').trigger('change');
        }

        function testPriceChange() {
            logDebug('=== 単価変更テスト開始 ===');
            $('.invoice-items-table .price').first().val('1500').trigger('blur');
        }

        function testQuantityChange() {
            logDebug('=== 数量変更テスト開始 ===');
            $('.invoice-items-table .quantity').first().val('5').trigger('blur');
        }

        function clearDebug() {
            document.getElementById('debug-info').innerHTML = 'デバッグ情報がここに表示されます...';
        }
    </script>
</body>
</html> 