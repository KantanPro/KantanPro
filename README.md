# KantanPro (KTPWP)

WordPressで動作する業務管理・受注進捗・請求・顧客・サービス・協力会社・レポート・スタッフチャットまで一元管理できる多機能プラグイン。

---

## 説明
KantanProは、WordPress上で以下の業務を一元管理できる多機能プラグインです。

**主要機能：**
- モバイル(iOS/Android)実機でも崩れない直感的UI（gap→margin対応、UI/UX改善）
- 受注書・請求書のPDF出力（個別・一括・強化版）
- サービス選択ポップアップ（伝票編集時、UI改善）
- スタッフチャット（自動スクロール・削除連動・安定化）
- ログインユーザーアバター・スタッフ表示
- ヘルプ（リファレンス）ボタン
- 強固なセキュリティ（XSS/CSRF/SQLi/権限管理/ファイル検証/ノンス/prepare文）
- ページネーション・検索・ソート・進捗/納期管理・警告マーク
- **【NEW】部署管理機能**（顧客ごとの部署・担当者管理）
- **【NEW】利用規約管理機能**（同意ダイアログ・管理画面）
- **【NEW】全テーブルのカラム自動追加（自動マイグレーション）**
- **【NEW】WP-CLIベースのマイグレーション管理機能**

---

## 主な機能
- **6つの管理タブ**（仕事リスト・伝票処理・得意先・サービス・協力会社・レポート）
- **受注案件の進捗管理**（7段階：受注→進行中→完了→請求→支払い→ボツ）
- **受注書・請求書の作成・編集・PDF保存**（個別・一括出力対応）
- **顧客・サービス・協力会社のマスター管理**（検索・ソート・ページネーション）
- **スタッフチャット**（自動スクロール・削除連動・安定化）
- **商品・サービスの詳細管理**（カテゴリー・価格・単位管理）
- **モバイルUI・アバター表示**（レスポンシブデザイン）
- **ヘルプ（リファレンス）機能**（使用方法の詳細解説）
- **データ検索・ソート・ページネーション**（大量データの効率的管理）
- **進捗・納期管理・警告マーク**（期限管理・アラート機能）
- **権限管理・安全なDBアクセス**（ロールベースアクセス制御）
- **【NEW】部署管理機能**（顧客ごとの部署・担当者管理）
- **【NEW】利用規約管理機能**（同意ダイアログ・管理画面）
- **【NEW】全テーブルのカラム自動追加（自動マイグレーション）**
- **【NEW】WP-CLIベースのマイグレーション管理機能**

---

## セキュリティ対策
- **SQLインジェクション防止**（prepare文・バインド変数）
- **XSS・CSRF対策**（サニタイズ・エスケープ・ノンス）
- **ファイルアップロード検証**（MIME型・サイズ制限）
- **権限管理・安全なDBアクセス**（ロールベースアクセス制御）
- **ノンス・トークンによるフォーム保護**（CSRF攻撃防止）
- **gap→margin対応によるUI崩れ防止**（iOS/Android実機対応）

---

## システム要件
- WordPress 5.0 以上
- PHP 7.4 以上
- MySQL 5.6 以上 または MariaDB 10.0 以上
- 推奨メモリ: 256MB 以上
- 推奨PHP拡張: GD（画像処理用）

---

## インストール
1. プラグインを `/wp-content/plugins/` にアップロード、または管理画面からインストール
2. プラグインを有効化（自動マイグレーションが実行されます）
3. 固定ページに `[ktpwp_all_tab]` を挿入
4. 管理画面「KantanPro」から基本設定を行ってください

---

## 基本的な使い方
1. **固定ページに `[ktpwp_all_tab]` を挿入**すると、6つのタブが表示されます
2. **各タブで顧客・サービス・協力会社・受注書・レポート等を管理**
3. **伝票編集時は「サービス選択」ポップアップから商品を追加**
4. **受注書・請求書はPDFで出力可能**（個別・一括対応）
5. **モバイルでも快適に操作可能**（レスポンシブデザイン）
6. **スタッフチャットでリアルタイムコミュニケーション**
7. **ヘルプボタンで使用方法を確認**
8. **顧客管理で部署・担当者を管理**
9. **利用規約に同意してから利用開始**

---

## 部署管理機能
- 顧客ごとに複数の部署・担当者を管理
- 部署ごとのメールアドレス管理
- 選択された部署の情報を請求書に反映
- 部署の追加・編集・削除機能

---

## 利用規約管理機能
- 利用規約の同意ダイアログ表示
- 管理画面での利用規約編集
- 利用規約バージョン管理
- 同意状態の追跡

---

## WP-CLIマイグレーション管理
KantanPro 1.3.0(beta) から、DB構造の変更はWP-CLIコマンドで安全に管理できます。

- `includes/migrations/` にマイグレーションファイルを追加
- 一括実行: `wp ktpwp migrate_all`
- 個別実行: `wp ktpwp migrate_YYYYMMDD_...`

プラグイン有効化時の自動マイグレーション処理は廃止されました。

---

## 変更履歴
### 1.3.1(beta)
- 部署管理機能を追加（顧客ごとの部署・担当者管理）
- 利用規約管理機能を追加（同意ダイアログ・管理画面）
- スタッフチャット機能の安定性向上
- モバイルUIのさらなる改善
- セキュリティ機能の強化
- その他細かなバグ修正・安定性向上

### 1.3.0(beta)
- WP-CLIベースのマイグレーション管理機能を導入
- プラグイン有効化時の自動マイグレーション処理を削除
- DB構造変更はWP-CLIコマンドで安全に実行可能に
- スタッフチャット機能の安定性向上
- モバイルUIのさらなる改善
- セキュリティ機能の強化
- その他細かなバグ修正・安定性向上

### 1.2.9(beta)
- 全テーブルのカラム自動追加（自動マイグレーション）機能を追加
- プラグイン有効化・初期化時にDB構造を自動アップデート
- スタッフチャット機能の改善
- モバイルUIの最適化
- その他細かなバグ修正・安定性向上

### 1.2.8(beta)
- PDF出力機能のさらなる強化
- UI/UXの細部改善（gap→margin対応、アバター表示強化）
- スタッフチャット機能の安定性向上
- サービス選択ポップアップの利便性向上
- セキュリティ強化（XSS/CSRF/SQLi/権限管理/ファイル検証/ノンス/prepare文）
- その他細かなバグ修正

### 1.2.7(beta)
- PDF出力機能のさらなる強化
- UI/UXの細部改善（gap→margin対応、アバター表示強化）
- スタッフチャット機能の安定性向上
- サービス選択ポップアップの利便性向上
- セキュリティ強化（XSS/CSRF/SQLi/権限管理/ファイル検証/ノンス/prepare文）
- その他細かなバグ修正

### 1.2.5(beta)
- PDF出力機能の強化
- UI/UXの改善（gap→margin対応、アバター表示強化）
- スタッフチャット機能の安定化
- サービス選択ポップアップの改善
- セキュリティ強化
- その他バグ修正

### 1.2.2(beta)
- 個別請求書・一括請求書のPDF保存
- 納期・未請求警告マーク
- モバイルUI・アバター・ヘルプボタン強化
- サービス選択ポップアップの自動クローズ制御
- gap→margin対応でiOS実機互換性向上

### 1.2.1(beta)
- モバイル表示の改善
- 進捗状況にボツ追加
- 納期管理機能追加

### 1.2.0(beta)
- 伝票処理タブの最終実装
- サービス・協力会社選択ポップアップ強化
- 行要素数値の最適化

---

## バージョン
1.3.1(beta)

---

## ライセンス
GPL v2 or later  
License URI: https://www.gnu.org/licenses/gpl-2.0.html

---

## サポート
プラグインに関するお問い合わせやサポートは、以下までご連絡ください：

**公式サイト**: https://www.kantanpro.com/  
**開発者プロフィール**: https://www.kantanpro.com/developer-profile/